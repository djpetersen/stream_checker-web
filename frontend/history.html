<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Checker - Test History</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .history-container {
            max-width: 100%;
            margin: 20px auto;
            padding: 20px;
            overflow-x: auto;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .history-header h1 {
            margin: 0;
        }
        .back-link {
            color: #9d7aff;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid #9d7aff;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .back-link:hover {
            background: #9d7aff;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2a45;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        thead {
            background: linear-gradient(135deg, #2d1b4e 0%, #1a0d2e 100%);
            color: white;
        }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #3a3a5c;
            font-size: 13px;
            color: #e0e0e0;
        }
        tbody tr:hover {
            background: #3a3a5c;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-success {
            background: #28a745;
            color: white;
        }
        .status-error {
            background: #dc3545;
            color: white;
        }
        .status-warning {
            background: #ffc107;
            color: #1a1a2e;
        }
        .health-score {
            font-weight: 600;
        }
        .health-good { color: #4ade80; }
        .health-warning { color: #fbbf24; }
        .health-critical { color: #f87171; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #b0b0b0;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f87171;
        }
        .refresh-btn {
            background: linear-gradient(135deg, #7c5aff 0%, #9d7aff 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .refresh-btn:hover {
            opacity: 0.9;
        }
        .compact {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="history-container">
        <div class="history-header">
            <h1>Test History</h1>
            <div>
                <a href="index.html" class="back-link">‚Üê Back to Checker</a>
                <a href="history_detailed.html" class="back-link" style="margin-left: 10px;">üìã Detailed View</a>
                <button class="refresh-btn" onclick="loadTests()">Refresh</button>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading test history...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="table-container" style="display: none; overflow-x: auto;">
            <table id="testsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Address</th>
                        <th>Stream URL</th>
                        <th>Test Run ID</th>
                        <th>Phase</th>
                        <th>Health Score</th>
                        <th>Connectivity Status</th>
                        <th>HTTP Status</th>
                        <th>Response Time (ms)</th>
                        <th>Content Type</th>
                        <th>Stream Type</th>
                        <th>Bitrate (kbps)</th>
                        <th>Codec</th>
                        <th>Player Test Status</th>
                        <th>VLC Connection Time (ms)</th>
                        <th>VLC Buffering Events</th>
                        <th>Silence Detected</th>
                        <th>Silence %</th>
                        <th>Ad Detection</th>
                        <th>Issues</th>
                        <th>Tests Completed</th>
                    </tr>
                </thead>
                <tbody id="testsBody">
                </tbody>
            </table>
            <div id="pagination" style="margin-top: 20px; text-align: center; display: none;">
                <button id="loadMoreBtn" class="refresh-btn" style="margin: 0 auto;">
                    Load More Tests
                </button>
                <p id="paginationInfo" style="color: #b0b0b0; margin-top: 10px; font-size: 0.9em;"></p>
            </div>
        </div>
    </div>

    <script>
        // Get API base URL (same logic as app.js)
        function getApiBaseUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiParam = urlParams.get('api');
            
            if (apiParam) {
                return apiParam.replace(/\/$/, '') + '/api';
            }
            
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:5000/api';
            }
            
            return 'http://YOUR-RASPBERRY-PI-IP:5000/api';
        }

        const API_BASE_URL = getApiBaseUrl();
        console.log('API Base URL:', API_BASE_URL);

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function getStatusBadge(status) {
            if (!status) return '<span class="status-badge">-</span>';
            const statusLower = status.toLowerCase();
            let className = 'status-warning';
            if (statusLower === 'success') className = 'status-success';
            else if (statusLower === 'error') className = 'status-error';
            return `<span class="status-badge ${className}">${status}</span>`;
        }

        function getHealthScoreClass(score) {
            if (score === null || score === undefined) return '';
            if (score >= 80) return 'health-good';
            if (score >= 60) return 'health-warning';
            return 'health-critical';
        }

        function extractValue(obj, path) {
            const keys = path.split('.');
            let value = obj;
            for (const key of keys) {
                if (value && typeof value === 'object' && key in value) {
                    value = value[key];
                } else {
                    return null;
                }
            }
            return value;
        }

        let currentOffset = 0;
        const pageSize = 50;
        let allTests = [];
        let hasMore = false;
        let totalTests = 0;
        
        async function loadTests(reset = true) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const tableContainer = document.getElementById('table-container');
            const testsBody = document.getElementById('testsBody');
            const pagination = document.getElementById('pagination');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (reset) {
                currentOffset = 0;
                allTests = [];
                loading.style.display = 'block';
            } else {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Loading...';
            }
            
            error.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/tests/all?limit=${pageSize}&offset=${currentOffset}`, {
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Merge new tests with existing ones
                if (data.tests && data.tests.length > 0) {
                    allTests = reset ? data.tests : [...allTests, ...data.tests];
                    hasMore = data.has_more || false;
                    totalTests = data.total || allTests.length;
                    currentOffset += data.tests.length;
                } else if (reset) {
                    allTests = [];
                    hasMore = false;
                    totalTests = 0;
                }
                
                if (allTests.length === 0) {
                    testsBody.innerHTML = '<tr><td colspan="21" style="text-align: center; padding: 40px;">No tests found</td></tr>';
                    pagination.style.display = 'none';
                } else {
                    testsBody.innerHTML = allTests.map(test => {
                        const r = test.results || {};
                        const conn = r.connectivity || {};
                        const params = r.stream_parameters || {};
                        const streamType = r.stream_type || {};
                        const playerTests = r.player_tests || {};
                        const vlc = playerTests.vlc || {};
                        const audio = r.audio_analysis || {};
                        const silence = audio.silence_detection || {};
                        const ad = r.ad_detection || {};
                        
                        return `
                            <tr>
                                <td>${formatTimestamp(test.timestamp)}</td>
                                <td><code style="font-size: 0.85em;">${test.ip_address || 'N/A'}</code></td>
                                <td class="compact" title="${test.stream_url || ''}">${test.stream_url || 'N/A'}</td>
                                <td class="compact" title="${test.test_run_id}">
                                    <a href="history_detailed.html?test_run_id=${test.test_run_id}" 
                                       style="color: #9d7aff; text-decoration: none; font-family: monospace;"
                                       onmouseover="this.style.textDecoration='underline'"
                                       onmouseout="this.style.textDecoration='none'">
                                        ${test.test_run_id.substring(0, 8)}...
                                    </a>
                                </td>
                                <td>${test.phase || 'N/A'}</td>
                                <td class="health-score ${getHealthScoreClass(r.health_score)}">
                                    ${r.health_score !== null && r.health_score !== undefined ? r.health_score : 'N/A'}
                                </td>
                                <td>${getStatusBadge(conn.status)}</td>
                                <td>${conn.http_status || 'N/A'}</td>
                                <td>${conn.response_time_ms || 'N/A'}</td>
                                <td class="compact">${conn.content_type || 'N/A'}</td>
                                <td>${streamType.type || 'N/A'}</td>
                                <td>${params.bitrate_kbps || 'N/A'}</td>
                                <td>${params.codec || 'N/A'}</td>
                                <td>${getStatusBadge(vlc.status)}</td>
                                <td style="text-align: right;">${vlc.connection_time_ms !== null && vlc.connection_time_ms !== undefined ? vlc.connection_time_ms + ' ms' : 'N/A'}</td>
                                <td style="text-align: right;">${vlc.buffering_events !== null && vlc.buffering_events !== undefined ? vlc.buffering_events : 'N/A'}</td>
                                <td>${silence.silence_detected ? 'Yes' : 'No'}</td>
                                <td>${silence.silence_percentage !== null && silence.silence_percentage !== undefined ? silence.silence_percentage.toFixed(1) + '%' : 'N/A'}</td>
                                <td>${ad.status ? getStatusBadge(ad.status) : 'N/A'}</td>
                                <td>${r.issues && r.issues.length > 0 ? r.issues.length : '0'}</td>
                                <td>${r.tests_completed ? r.tests_completed.join(', ') : 'N/A'}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Update pagination info
                    paginationInfo.textContent = `Showing ${allTests.length} of ${totalTests} tests`;
                    
                    // Show/hide load more button
                    if (hasMore) {
                        pagination.style.display = 'block';
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Load More Tests';
                    } else {
                        pagination.style.display = 'none';
                    }
                }
                
                loading.style.display = 'none';
                tableContainer.style.display = 'block';
                
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `Error loading tests: ${err.message}`;
                console.error('Error loading tests:', err);
                if (!reset) {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Load More Tests';
                }
            }
        }

        // Load tests on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTests(true);
            document.getElementById('loadMoreBtn').addEventListener('click', () => {
                loadTests(false);
            });
        });
    </script>
</body>
</html>
